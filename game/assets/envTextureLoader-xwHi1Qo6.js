const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/rgbdDecode.fragment-FmDEMm2_.js","assets/index-C8SlU0Sy.js","assets/index-DXwS0Rpr.css","assets/helperFunctions-CFPOV0G4.js","assets/rgbdDecode.fragment-mrGAwd9h.js","assets/helperFunctions-DwRWTzOH.js"])))=>i.map(i=>d[i]);
import{B as L,c as U,a as B,V as d,I as S,T as z,e as V,f as C}from"./index-C8SlU0Sy.js";import{C as G,P as k}from"./passPostProcess-DIhqjUy-.js";import"./dumpTools-YI7ue2xq.js";L.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(L.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=G.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0});const M="image/png",D=2,F=[134,22,135,150,246,214,150,54];function H(e){const n=new DataView(e.buffer,e.byteOffset,e.byteLength);let r=0;for(let a=0;a<F.length;a++)if(n.getUint8(r++)!==F[a])return U.Error("Not a babylon environment map"),null;let i="",o=0;for(;o=n.getUint8(r++);)i+=String.fromCharCode(o);let t=JSON.parse(i);return t=v(t),t.binaryDataPosition=r,t.specular&&(t.specular.lodGenerationScale=t.specular.lodGenerationScale||.8),t}function v(e){if(e.version>D)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${D}".`);return e.version===2||(e={...e,version:2,imageType:M}),e}function N(e,n){n=v(n);const r=n.specular;let i=Math.log2(n.width);if(i=Math.round(i)+1,r.mipmaps.length!==6*i)throw new Error(`Unsupported specular mipmaps number "${r.mipmaps.length}"`);const o=new Array(i);for(let t=0;t<i;t++){o[t]=new Array(6);for(let a=0;a<6;a++){const s=r.mipmaps[t*6+a];o[t][a]=new Uint8Array(e.buffer,e.byteOffset+n.binaryDataPosition+s.position,s.length)}}return o}function $(e,n){n=v(n);const r=new Array(6),i=n.irradiance?.irradianceTexture;if(i){if(i.faces.length!==6)throw new Error(`Incorrect irradiance texture faces number "${i.faces.length}"`);for(let o=0;o<6;o++){const t=i.faces[o];r[o]=new Uint8Array(e.buffer,e.byteOffset+n.binaryDataPosition+t.position,t.length)}}return r}function Y(e,n,r){r=v(r);const i=r.specular;if(!i)return Promise.resolve([]);e._lodGenerationScale=i.lodGenerationScale;const o=[],t=N(n,r);o.push(j(e,t,r.imageType));const a=r.irradiance?.irradianceTexture;if(a){const s=$(n,r);let p=null;r.irradiance?.irradianceTexture?.dominantDirection&&(p=d.FromArray(r.irradiance.irradianceTexture.dominantDirection)),o.push(W(e,s,a.size,r.imageType,p))}return Promise.all(o)}async function O(e,n,r,i,o,t,a,s,p,m,T){return await new Promise((h,A)=>{if(r){const y=n.createTexture(null,!0,!0,null,1,null,l=>{A(l)},e);i?.onEffectCreatedObservable.addOnce(l=>{l.executeWhenCompiled(()=>{i.externalTextureSamplerBinding=!0,i.onApply=c=>{c._bindTexture("textureSampler",y),c.setFloat2("scale",1,n._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},n.scenes.length&&(n.scenes[0].postProcessManager.directRender([i],m,!0,t,a),n.restoreDefaultFramebuffer(),y.dispose(),URL.revokeObjectURL(o),h())})})}else{if(n._uploadImageToTexture(T,e,t,a),s){const y=p[a];y&&n._uploadImageToTexture(y._texture,e,t,0)}h()}})}async function j(e,n,r=M){const i=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,i.updateTextureSamplingMode(3,e),await E(e,n,!0,r),e.isReady=!0}async function W(e,n,r,i=M,o=null){const t=e.getEngine(),a=new S(t,5),s=new L(t,a);e._irradianceTexture=s,s._dominantDirection=o,a.isCube=!0,a.format=5,a.type=0,a.generateMipMaps=!0,a._cachedAnisotropicFilteringLevel=null,a.generateMipMaps=!0,a.width=r,a.height=r,t.updateTextureSamplingMode(3,a),await E(a,[n],!1,i),t.generateMipMapsForCubemap(a),a.isReady=!0}async function E(e,n,r,i=M){if(!z.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const o=V(e.width)+1,t=e.getEngine();let a=!1,s=!1,p=null,m=null,T=null;const h=t.getCaps();h.textureLOD?t._features.supportRenderAndCopyToLodForFloatTextures?h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?(a=!0,e.type=2):h.textureFloatRender&&h.textureFloatLinearFiltering&&(a=!0,e.type=1):a=!1:(a=!1,s=r);let A=0;if(a)t.isWebGPU?(A=1,await C(()=>import("./rgbdDecode.fragment-FmDEMm2_.js"),__vite__mapDeps([0,1,2,3]))):await C(()=>import("./rgbdDecode.fragment-mrGAwd9h.js"),__vite__mapDeps([4,1,2,5])),p=new k("rgbdDecode","rgbdDecode",null,null,1,null,3,t,!1,void 0,e.type,void 0,null,!1,void 0,A),e._isRGBD=!1,e.invertY=!1,m=t.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,s){T={};const c=e._lodGenerationScale,_=e._lodGenerationOffset;for(let u=0;u<3;u++){const w=1-u/2,f=_,R=(o-1)*c+_,I=f+(R-f)*w,b=Math.round(Math.min(Math.max(I,0),R)),P=new S(t,2);P.isCube=!0,P.invertY=!0,P.generateMipMaps=!1,t.updateTextureSamplingMode(2,P);const x=new L(null);switch(x._isCube=!0,x._texture=P,T[b]=x,u){case 0:e._lodTextureLow=x;break;case 1:e._lodTextureMid=x;break;case 2:e._lodTextureHigh=x;break}}}const y=[];for(let l=0;l<n.length;l++)for(let c=0;c<6;c++){const _=n[l][c],u=new Blob([_],{type:i}),g=URL.createObjectURL(u);let w;if(t._features.forceBitmapOverHTMLImageElement)w=t.createImageBitmap(u,{premultiplyAlpha:"none"}).then(async f=>await O(f,t,a,p,g,c,l,s,T,m,e));else{const f=new Image;f.src=g,w=new Promise((R,I)=>{f.onload=()=>{O(f,t,a,p,g,c,l,s,T,m,e).then(()=>R()).catch(b=>{I(b)})},f.onerror=b=>{I(b)}})}y.push(w)}if(await Promise.all(y),n.length<o){let l;const c=Math.pow(2,o-1-n.length),_=c*c*4;switch(e.type){case 0:{l=new Uint8Array(_);break}case 2:{l=new Uint16Array(_);break}case 1:{l=new Float32Array(_);break}}for(let u=n.length;u<o;u++)for(let g=0;g<6;g++)t._uploadArrayBufferViewToTexture(m?.texture||e,l,g,u)}if(m){const l=e._irradianceTexture;e._irradianceTexture=null,t._releaseTexture(e),m._swapAndDie(e),e._irradianceTexture=l}p&&p.dispose(),s&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}function J(e,n){n=v(n);const r=n.irradiance;if(!r)return;const i=new B;d.FromArrayToRef(r.x,0,i.x),d.FromArrayToRef(r.y,0,i.y),d.FromArrayToRef(r.z,0,i.z),d.FromArrayToRef(r.xx,0,i.xx),d.FromArrayToRef(r.yy,0,i.yy),d.FromArrayToRef(r.zz,0,i.zz),d.FromArrayToRef(r.yz,0,i.yz),d.FromArrayToRef(r.zx,0,i.zx),d.FromArrayToRef(r.xy,0,i.xy),e._sphericalPolynomial=i}class X{constructor(){this.supportCascades=!1}loadCubeData(n,r,i,o,t){if(Array.isArray(n))return;const a=H(n);if(a){r.width=a.width,r.height=a.width;try{J(r,a),Y(r,n,a).then(()=>{r.isReady=!0,r.onLoadedObservable.notifyObservers(r),r.onLoadedObservable.clear(),o&&o()},s=>{t?.("Can not upload environment levels",s)})}catch(s){t?.("Can not upload environment file",s)}}else t&&t("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}export{X as _ENVTextureLoader};
